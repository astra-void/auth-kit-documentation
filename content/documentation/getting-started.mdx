# Getting Started

## Install
```bash
npm i @astra-void/auth-kit
```

or

```bash
pnpm add @astra-void/auth-kit
```

## Directory Structure

Set up your project like this:

```txt
ðŸ“‚ your-nextjs-app
â”‚ app/
â”‚  â””â”€ api/
â”‚     â””â”€ auth/
â”‚        â””â”€ [...authkit]/
â”‚           â””â”€ route.ts
â””â”€ middleware.ts
```

## Setup
This setup assumes you're using [Prisma](https://www.prisma.io/).

### `app/api/auth/[...authkit]/route.ts`

```ts
import { Adapter, AuthKit } from "@astra-void/auth-kit";

const handler = AuthKit({
  adapter: PrismaAdapter(prisma),
});

export { handler as GET, handler as POST };
```

> ðŸ’¡ If you're using a custom adapter or another database, see [Adapters](/adapters/overview).

#### If you want to use passkey
```ts
const handler = AuthKit({
    adapter: PrismaAdapter(prisma),
    passkey: {
        rpId: "localhost", // Your rpId
        rpName: "Passkey", // Your rpName
        mode: "email", // default is email, but you can use credential
        challengeStore: YourChallengeStore // Your Challenge Store; default redis store will be provided next version.
    }
});

export { handler as GET, handler as POST };
```
+ If Challenge Store is not provided, in-memory challenge store will be used (not recommended for production).

### Challenge Store interface
```ts
export interface ChallengeStore {
    get: (userId: string) => Promise<string | null>;
    set: (userId: string, challenge: string) => Promise<void>;
    delete: (userId: string) => Promise<void>;
}
```

### Example for Redis
```ts
import { ChallengeStore } from "@astra-void/auth-kit";

const PREFIX = "passkey:challenge";

const RedisChallengeStore: ChallengeStore = {
    get: async (userId) => {
        const key = `${PREFIX}:${userId}`;
        return await redis.get(key);
    },

    set: async (userId, challenge) => {  
        const key = `${PREFIX}:${userId}`;
        await redis.set(key, challenge, "EX", 300);
        return;
    },

    delete: async (userId) => {
        const key = `${PREFIX}:${userId}`;
        await redis.del(key);
    }
};
```

### Prisma schema for default Prisma Adapter
```ts
model User {
  id             String    @id @default(uuid())
  email          String    @unique
  hashedPassword String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  passkeys       Passkey[]
}

model Passkey {
  id         String   @id @default(uuid())
  publicKey  Bytes
  userId     String
  webAuthnId Bytes    @unique
  counter    Int      @default(0)
  transports String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}
```
+ This Prisma schema is written for SQL-based databases (e.g. PostgreSQL, MySQL).

### `middleware.ts`

This middleware enables CSRF protection and guards protected routes.

```ts
import { AuthKitMiddleware } from "@astra-void/auth-kit/middleware";

const middleware = AuthKitMiddleware({
  loginPath: '/login', // default: '/login'
  logoutPath: '/logout', // default: '/logout'
  registerPath: '/register', // default: '/register'
  protectedRoutes: ['dashboard'], // protected routes
  alwaysSetToken: false, // default: false
});

export { middleware };
```
+ Matcher
```ts
export const config = {
  matcher: ['/((?!api|_next/static|favicon.ico).*)'],
};
```

## Client Usage

### Login 

```ts
import { login } from '@astra-void/auth-kit/react';

await login({ email: 'test@example.com', password: '12345678' });
```

### Logout

```ts
import { logout } from '@astra-void/auth-kit/react';

await logout();
```

### Register

```ts
import { register } from '@astra-void/auth-kit/react';

await register({ email: 'test@example.com', password: '12345678' });
```

### Login with Passkey
```ts
import { loginPasskey } from "@astra-void/auth-kit/react/passkey";

await loginPasskey({ email: 'test@example.com' });
```
#### If you are using credential
```ts
import { loginPasskey } from "@astra-void/auth-kit/react/passkey";

await loginPasskey();
```

### Register new Passkey (should logged in)
```ts
import { registerPasskey } from "@astra-void/auth-kit/react/passkey";

await registerPasskey();
```

### Session Hook

```ts
import { useSession } from "@astra-void/auth-kit/react";
import { useRouter } from "next/navigation";

const router = useRouter();
const { data: user, status } = useSession();

if (status === "loading") return <Spinner />;
if (status === "unauthenticated") router.push("/login");

return <p>Welcome {user?.email}!</p>;
```
+ The status is 'authenticated' | 'unauthenticated' | 'loading';

â†’ Check out the [Adapters](../adapters/overview) and [API Reference](../reference) for advanced usage.