import InstallTabs from "../../app/components/InstallTabs";

# Getting Started

## Install

<InstallTabs />

## Directory Structure

Set up your project like this:

```txt
ðŸ“‚ your-nextjs-app
â”‚ app/
â”‚  â””â”€ api/
â”‚     â””â”€ auth/
â”‚        â””â”€ [...authkit]/
â”‚           â””â”€ route.ts
â””â”€ middleware.ts
```

## Setup
This setup assumes you're using [Prisma](https://www.prisma.io/).

### Secret

```env
AUTHKIT_SECRET = "your_secret_here"
```
`AUTHKIT_SECRET` is a critical value used internally to sign tokens. Please keep the following in mind:
+ Use a sufficiently long random string (recommended: at least 32 characters, mixing uppercase, lowercase, numbers, and special characters)
+ Never commit this secret to version control
+ Use different secrets for development and production environments
+ Manage secrets securely using environment variables or secret management tools (e.g., Vercel Environment Variables, Docker Secrets)

### `app/api/auth/[...authkit]/route.ts`

```ts
import { AuthKit } from "@astra-void/auth-kit";
import { PrismaAdapter } from "@astra-void/auth-kit/adapters";

const handler = AuthKit({
  adapter: PrismaAdapter(prisma),
});

export { handler as GET, handler as POST };
```

> ðŸ’¡ If you're using a custom adapter or another database, see [Adapters](/documentation/adapters/overview).

#### If you want to use passkey
```ts
import { AuthKit } from "@astra-void/auth-kit";
import { PrismaAdapter } from "@astra-void/auth-kit/adapters";

const handler = AuthKit({
    adapter: PrismaAdapter(prisma),
    passkey: {
        rpId: "localhost", // Your rpId
        rpName: "Passkey", // Your rpName
        mode: "email", // default is email, but you can use credential
        challengeStore: YourChallengeStore // Your Challenge Store
    }
});

export { handler as GET, handler as POST };
```
> âš ï¸ If no Challenge Store is provided, an in-memory store will be used, which is **not recommended for production**.

### Challenge Store interface
```ts
export interface ChallengeStore {
    get: (userId: string) => Promise<string | null>;
    set: (userId: string, challenge: string) => Promise<void>;
    delete: (userId: string) => Promise<void>;
}
```

### Built-in Challenge Store for Redis
```ts
import { AuthKit } from "@astra-void/auth-kit";
import { PrismaAdapter } from "@astra-void/auth-kit/adapters";
import { RedisChallengeStore } from "@astra-void/auth-kit/store";

const handler = AuthKit({
    adapter: PrismaAdapter(prisma),
    passkey: {
        rpId: "localhost", // Your rpId
        rpName: "Passkey", // Your rpName
        mode: "email", // default is email, but you can use credential
        challengeStore: RedisChallengeStore(redis),
    }
});
```

### Prisma schema for default Prisma Adapter
```prisma
model User {
  id             String    @id @default(uuid())
  email          String    @unique
  hashedPassword String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  passkeys       Passkey[]
}

model Passkey {
  id         String   @id @default(uuid())
  publicKey  Bytes
  userId     String
  webAuthnId Bytes    @unique
  counter    Int      @default(0)
  transports String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}
```
+ This Prisma schema is written for SQL-based databases (e.g. PostgreSQL, MySQL).

### `middleware.ts`

This middleware enables CSRF protection and guards protected routes.

```ts
import { AuthKitMiddleware } from "@astra-void/auth-kit/middleware";

const middleware = AuthKitMiddleware({
  loginPath: '/login', // default: '/login'
  logoutPath: '/logout', // default: '/logout'
  registerPath: '/register', // default: '/register'
  protectedRoutes: ['dashboard'], // protected routes
  alwaysSetToken: false, // default: false
});

export { middleware };
```
+ Matcher
```ts
export const config = {
  matcher: ['/((?!api|_next/static|favicon.ico).*)'],
};
```

## Client Usage

### Login 

```ts
import { login } from '@astra-void/auth-kit/react';

await login({ email: 'test@example.com', password: '12345678' });
```

### Logout

```ts
import { logout } from '@astra-void/auth-kit/react';

await logout();
```

### Register

```ts
import { register } from '@astra-void/auth-kit/react';

await register({ email: 'test@example.com', password: '12345678' });
```

### Login with Passkey
```ts
import { loginPasskey } from "@astra-void/auth-kit/react/passkey";

await loginPasskey({ email: 'test@example.com' });
```
#### If you are using credential
```ts
import { loginPasskey } from "@astra-void/auth-kit/react/passkey";

await loginPasskey();
```

### Register new Passkey (should logged in)
```ts
import { registerPasskey } from "@astra-void/auth-kit/react/passkey";

await registerPasskey();
```

### Session Hook

```ts
import { useSession } from "@astra-void/auth-kit/react";
import { useRouter } from "next/navigation";

const router = useRouter();
const { data: session } = useSession();

if (session.status === "loading") return <Spinner />;
if (session.status === "unauthenticated") router.push("/login");

return <p>Welcome {session.user?.email}!</p>;
```
+ The status is 'authenticated' | 'unauthenticated' | 'loading';

â†’ Check out the [Adapters](/documentation/adapters/overview) for advanced usage.